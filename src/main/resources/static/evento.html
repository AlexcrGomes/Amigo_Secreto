<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Evento - Amigo Secreto</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2 { color: #333; }
        table { border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 5px 10px; }
        button { padding: 4px 8px; margin-left: 5px; }
        form { margin-top: 20px; }
        label { display: block; margin-top: 10px; }
        input[type="text"] { width: 300px; padding: 5px; }
        .status { margin-top: 10px; font-weight: bold; }
        .voltar { margin-bottom: 10px; display: inline-block; }
    </style>
</head>
<body>
<a class="voltar" href="index.html">&larr; Voltar para lista de eventos</a>
<h1 id="titulo-evento">Carregando...</h1>
<div class="status" id="status-evento"></div>

<button id="btn-fechar">Fechar evento</button>

<h2>Participantes</h2>
<table id="tabela-participantes">
    <thead>
    <tr>
        <th>ID</th>
        <th>Nome</th>
        <th>CPF</th>
        <th>Ações</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<h2>Entrar no evento (adicionar participante)</h2>
<form id="form-participante">
    <label>Nome:
        <input type="text" id="nome-participante" required>
    </label>
    <label>CPF:
        <input type="text" id="cpf-participante" required>
    </label>
    <button type="submit">Entrar / Adicionar</button>
</form>

<script>
    const apiBase = '/api';
    const params = new URLSearchParams(window.location.search);
    const eventoId = params.get('id');

    if (!eventoId) {
      alert('ID do evento não informado');
    }

    async function carregarEvento() {
      const resp = await fetch(`${apiBase}/eventos/${eventoId}`);
      if (!resp.ok) {
        alert('Erro ao carregar evento');
        return;
      }
      const evento = await resp.json();
      document.getElementById('titulo-evento').innerText = evento.nome;
      document.getElementById('status-evento').innerText = 'Status: ' + evento.status;
    }

    async function carregarParticipantes() {
      const resp = await fetch(`${apiBase}/eventos/${eventoId}/participantes`);
      const participantes = await resp.json();

      const tbody = document.querySelector('#tabela-participantes tbody');
      tbody.innerHTML = '';

      participantes.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.nome}</td>
          <td>${p.cpf}</td>
          <td>
            <button onclick="sortear(${p.id}, '${p.nome.replace(/'/g, "\\'")}')">
              Sortear amigo
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function sortear(participanteId, participanteNome) {
      const resp = await fetch(`${apiBase}/eventos/${eventoId}/sorteio/${participanteId}`, {
        method: 'POST'
      });

      if (!resp.ok) {
        const texto = await resp.text();
        alert('Erro no sorteio: ' + texto);
        return;
      }

      const resultado = await resp.json();
      alert(`Participante: ${resultado.participanteNome}\nAmigo Secreto: ${resultado.amigoNome}`);
    }

    // fechar evento
    document.getElementById('btn-fechar').addEventListener('click', async () => {
      const resp = await fetch(`${apiBase}/eventos/${eventoId}/fechar`, { method: 'POST' });
      if (resp.ok) {
        alert('Evento fechado!');
        carregarEvento();
      } else {
        alert('Erro ao fechar evento');
      }
    });

    // adicionar participante
    document.getElementById('form-participante').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nome = document.getElementById('nome-participante').value;
      const cpf = document.getElementById('cpf-participante').value;

      const resp = await fetch(`${apiBase}/eventos/${eventoId}/participantes`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ nome, cpf })
      });

      if (resp.ok) {
        alert('Participante adicionado!');
        document.getElementById('nome-participante').value = '';
        document.getElementById('cpf-participante').value = '';
        carregarParticipantes();
      } else {
        const texto = await resp.text();
        alert('Erro ao adicionar participante: ' + texto);
      }
    });

    // Inicialização
    carregarEvento();
    carregarParticipantes();
</script>
</body>
</html>
